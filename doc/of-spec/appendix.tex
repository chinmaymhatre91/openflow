
%\appendix
\section{The OpenFlow Protocol}
The heart of the OpenFlow spec is the set of structures used for OpenFlow Protocol messages.  
\\\\
The structures, defines, and enumerations described below are derived from the file \verb|include/openflow/openflow.h|, which is part of the standard OpenFlow specification distribution.  All structures are packed with padding and 8-byte aligned, as checked by the assertion statements.  All OpenFlow messages are sent in big-endian format.  

\subsection{OpenFlow Header}
Each OpenFlow message begins with the OpenFlow header:

\input{struct/ofp_header}
The \verb|version| specifies the OpenFlow protocol version being used.  During the current draft phase of the OpenFlow Protocol, the most significant bit will be set to indicate an experimental version and the lower bits will indicate a revision number.  The current version is \input{define/OFP_VERSION}.  The \verb|length| field indicates the total length of the message, so no additional framing is used to distinguish one frame from the next.  The \verb|type| can have the following values:

\input{enum/ofp_type}

\subsection{Common Structures}
This section describes structures used by multiple messages.

\subsubsection{Port Structures}
The OpenFlow pipeline receives and sends packets on ports. The switch may define physical and virtual ports, and the OpenFlow specification defines some reserved virtual ports.
\\\\
The physical ports, switch-defined virtual ports, and the \verb|OFPP_LOCAL| port are described with the following structure:

\input{struct/ofp_port}
The \verb|port_no| field uniquely identifies a port within a switch. The \verb|hw_addr| field typically is the MAC address for the port; \verb|OFP_MAX_ETH_ALEN| is 6.  The name field is a null-terminated string containing a human-readable name for the interface.  The value of \verb|OFP_MAX_PORT_NAME_LEN| is 16.
\\\\
The \verb|config| field describes port administrative settings, and has the following structure:

\input{enum/ofp_port_config}
The \verb|OFPPC_PORT_DOWN| bit indicates that the port has been administratively brought down and should not be used by OpenFlow. The \verb|OFPPC_NO_RECV| bit indicates that packets received on that port should be ignored. The \verb|OFPPC_NO_FWD| bit indicates that OpenFlow should not send packets to that port. The \verb|OFPPFL_NO_PACKET_IN| bit indicates that packets on that port that generate a table miss should never trigger a packet-in message to the controller.
\\\\
In general, the port config bits are set by the controller and not changed by the switch. Those bits may be useful for the controller to implement protocols such as STP or BFD. If the port config bits are changed by the switch through another administrative interface, the switch sends an \verb|OFPT_PORT_STATUS| message to notify the controller of the change.
\\\\
The \verb|state| field describes the port internal state, and has the following structure:

\input{enum/ofp_port_state}
The port state bits represent the state of the physical link or switch protocols outside of OpenFlow. The \verb|OFPPS_LINK_DOWN| bit indicates the the physical link is not present. The \verb|OFPPS_BLOCKED| bit indicates that a switch protocol outside of OpenFlow, such as 802.1D Spanning Tree, is preventing the use of that port with \verb|OFPP_FLOOD|.
\\\\
All port state bits are read-only and cannot be changed by the controller. When the port flags are changed, the switch sends an \verb|OFPT_PORT_STATUS| message to notify the controller of the change.
\\\\
The port numbers use the following conventions:

\input{enum/ofp_port_no}
The \verb|curr|, \verb|advertised|, \verb|supported|, and \verb|peer| fields indicate link modes (speed and duplexity), link type (copper/fiber) and link features (autonegotiation and pause).  Port features are represented by the following structure:

\input{enum/ofp_port_features}
Multiple of these flags may be set simultaneously. If none of the port speed flags are set, the \verb|max_speed| or \verb|curr_speed| are used.
\\\\
The \verb|curr_speed| and \verb|max_speed| fields indicate the current and maximum bit rate (raw transmission speed) of the link in kbps. The number should be rounded to match common usage. For example, an optical 10 Gb Ethernet port should have this field set to 10000000 (instead of 10312500), and an OC-192 port should have this field set to 10000000 (instead of 9953280).
\\\\
The \verb|max_speed| fields indicate the maximum configured capacity of the link, whereas the \verb|curr_speed| indicates the current capacity. If the port is a LAG with 3 links of 1Gb/s capacity, with one of the ports of the LAG being down, one port auto-negotiated at 1Gb/s and 1 port auto-negotiated at 100Mb/s, the \verb|max_speed| is 3 Gb/s and the \verb|curr_speed| is 1.1 Gb/s.

\subsubsection{Queue Structures}
\label{cts:qos}
An OpenFlow switch provides limited Quality-of-Service support
  (QoS) through a simple queuing
mechanism. One (or more) queues can attach to a port and be used to map flows
on it. Flows mapped to a specific queue will be treated according to
that queue's configuration (e.g. min rate).
\\\\
A queue is described by the \verb|ofp_packet_queue| structure:
\input{struct/ofp_packet_queue}
Each queue is further described by a set of properties, each of a
specific type and configuration.
\input{enum/ofp_queue_properties}
Each queue property description starts with a common header:
\input{struct/ofp_queue_prop_header}
Currently, there is only a minimum-rate type queue, described by the
\verb|ofp_queue_prop_min_rate| structure:
\input{struct/ofp_queue_prop_min_rate}

\subsubsection{Flow Match Structures}
When describing a flow entry, the following structures are used:

\input{enum/ofp_match_type}

\input{struct/ofp_match}
The \verb|type| field is set to \verb|OFPMT_STANDARD| and \verb|length| field is set to \verb|OFPMT_STANDARD_LENGTH| by default. If the match needs to be extended, these fields may be modified.
\\\\
The constant \verb|OFPMT_STANDARD_LENGTH| is defined to be \input{define/OFPMT_STANDARD_LENGTH}.
\\\\
Protocol-specific fields within \verb|ofp_match| will be ignored within a single table when the corresponding protocol is not specified in the match. The MPLS match fields will be ignored unless the Ethertype is specified as MPLS. Likewise, the IP header and transport header fields will be ignored unless the Ethertype is specified as either IPv4 or ARP. The \verb|tp_src| and \verb|tp_dst| fields will be ignored unless the network protocol specified is as TCP, UDP or SCTP. Fields that are ignored don't need to be wildcarded and should be set to 0.
\\\\
The \verb|wildcards| field has a number of flags that may be set:

\input{enum/ofp_flow_wildcards}

The metadata field is used to pass information between lookups across multiple tables. This value can be masked using the metadata mask (which is \verb|0xFFFFFFFFFFFFFFFF| by default).
\\\\
There are also four match field masks: \verb|dl_src_mask|, \verb|dl_dst_mask|, \verb|nw_src_mask|, and \verb|nw_dst_mask|. These mask fields allow the corresponding fields (\verb|dl_src|, \verb|dl_dst|, \verb|nw_src|, and \verb|nw_dst|) to be masked arbitrarily. The masks are defined such that a 1 in a given bit position indicates a ``don't care'' match for the same bit in the corresponding field, whereas a 0 means match the bit exactly.
\\\\
If no wildcards are set and the \verb|_mask| fields are all zero, then the \verb|ofp_match| exactly describes a flow, over the entire OpenFlow n-tuple.  On the other extreme, if all the wildcard flags and \verb|_mask| fields are set, then every flow will match.
\\\\
Setting the \verb|OFPFW_DL_VLAN| bit in the \verb|wildcards| field specifies that a flow should match packets regardless of whether they contain the corresponding tag. Special values are defined below for the VLAN tag to allow matching of packets with any tag, independent of the tag's value, and to supports matching packets without a VLAN tag. The special values defined for \verb|dl_vlan| are:
\input{enum/ofp_vlan_id}
The \verb|dl_vlan_pcp| field must be ignored when the \verb|OFPFW_DL_VLAN| wildcard bit is set or when the \verb|dl_vlan| value is set to \verb|OFPVID_NONE|.
\\\\
Table~\ref{table:vlan wildcards} summarizes the combinations of wildcard bits and field values for particular matches.

\begin{table}[hbp]
\centering
\begin{tabularx}{\textwidth}{|c|c|X|}
\hline
Wildcard bit & \verb|dl_vlan| value & Matching packets \\
\hline
\verb|OFPFW_DL_VLAN| & * & Packets with and without a VLAN tag \\
\hline
- & \verb|OFPVID_NONE| & Only packets \emph{without} a VLAN tag \\
\hline
- & \verb|OFPVID_ANY| & Only packets \emph{with} a VLAN tag regardless of it's value \\
\hline
\end{tabularx}
\caption{Match combinations for VLAN tags.}
\label{table:vlan wildcards}
\end{table}

\subsubsection{Flow Instruction Structures}
Flow instructions associated with a flow table entry are executed when a flow matches the entry. The list of instructions that are currently defined are:

\input{enum/ofp_instruction_type}
The instruction set is described in section \ref{ft:instructions}.  Flow tables may support a subset of instruction types.
\\\\
The \verb|OFPIT_GOTO_TABLE| instruction uses the following structure and fields:
\input{struct/ofp_instruction_goto_table}
\verb|table_id| indicates the next table in the packet processing pipeline.
\\\\
The \verb|OFPIT_WRITE_METADATA| instruction uses the following structure and fields:
\input{struct/ofp_instruction_write_metadata}
Metadata for the next table lookup can be written using the \verb|metadata| and the \verb|metadata_mask| in order to set specific bits on the match field.   If this instruction is not specified, the metadata is passed, unchanged.
\\\\
The \verb|OFPIT_WRITE_ACTIONS|, \verb|OFPIT_APPLY_ACTIONS|, and \verb|OFPIT_CLEAR_ACTIONS| instructions use the following structure and fields:
\input{struct/ofp_instruction_actions}
For the Apply-Actions instruction, the \verb|actions| field is treated as a list and the actions are applied to the packet \emph{in-order}. For the Write-Actions instruction, the \verb|actions| field is treated as a set and the actions are merged into the current action set.
\\\\
For the Clear-Actions instruction, the structure does not contain any actions.

\subsubsection{Action Structures}
\label{sec:action structure}
A number of actions may be associated with flows, groups or packets.  The currently defined action types are:

\input{enum/ofp_action_type} 
Output, group, and set-queue actions are described in Section~\ref{ft:actions}, tag push/pop actions are described in Table~\ref{table:push pop actions}, and Set-Field actions are described in Table~\ref{table:set-field actions}.  An action definition contains the action type, length, and any associated data:

\input{struct/ofp_action_header}
An \emph{Output} action uses the following structure and fields:

\input{struct/ofp_action_output}
The \verb|max_len| indicates the maximum amount of data from a packet that should be sent when the port is \verb|OFPP_CONTROLLER|.  If \verb|max_len| is zero, the switch must send a zero-size \verb|packet_in| message.  The \verb|port| specifies the port through which the packet should be sent.
\\\\
A \emph{Group} action uses the following structure and fields:

\input{struct/ofp_action_group}
The \verb|group_id| indicates the group used to process this packet.  The set of buckets to apply depends on the group type.
\\\\
The \emph{Set-Queue} action sets the queue id that will be used to map a flow to an already-configured queue, regardless of the TOS and VLAN PCP bits. The packet should not change as a result of a Set-Queue action. If the switch needs to set the TOS/PCP bits for internal handling, the original values should be restored before sending the packet out.
\\\\
A switch may support only queues that are tied to specific PCP/TOS bits. In that case, we cannot map an arbitrary flow to a specific queue, therefore the Set-Queue action is not supported. The user can still use these queues and map flows to them by setting the relevant fields (TOS, VLAN PCP).
\\\\
A \emph{Set Queue} action uses the following structure and fields:

\input{struct/ofp_action_set_queue}
A \emph{Set VLAN ID} action uses the following structure and fields:

\input{struct/ofp_action_vlan_vid}
The \verb|vlan_vid| field is 16 bits long, when an actual VLAN id is only 12 bits.
\\\\
A \emph{Set VLAN priority} action uses the following structure and fields:

\input{struct/ofp_action_vlan_pcp}
The \verb|vlan_pcp| field is 8 bits long, but only the lower 3 bits have meaning.  
\\\\
A \emph{Set MPLS label} action uses the following structure and fields:

\input{struct/ofp_action_mpls_label}
The \verb|mpls_label| field is 32 bits long, but only the lower 20 bits have meaning.
\\\\
A \emph{Set MPLS traffic class} action uses the following structure and fields:

\input{struct/ofp_action_mpls_tc}
The \verb|mpls_tc| field is 8 bits long, but only the lower 3 bits have meaning.
\\\\
A \emph{Set MPLS TTL} action uses the following structure and fields:

\input{struct/ofp_action_mpls_ttl}
The \verb|mpls_ttl| field is the MPLS TTL to set.
\\\\
A \emph{Decrement MPLS TTL} action takes no arguments and consists only of a generic \verb|ofp_action_header|. The action decrements the MPLS TTL.
\\\\
A \emph{Set Ethernet source address} action and \emph{Set Ethernet destination address} action use the following structure and fields:

\input{struct/ofp_action_dl_addr}
The \verb|dl_addr| field is the MAC address to set.
\\\\
A \emph{Set IPv4 source address} action and \emph{Set IPv4 destination address} action use the following structure and fields:

\input{struct/ofp_action_nw_addr}
The \verb|nw_addr| field is the IP address to set.
\\\\
A \emph{Set IPv4 ToS} action uses the following structure and fields:

\input{struct/ofp_action_nw_tos}
The \verb|nw_tos| field is the 6 upper bits of the ToS field to set, in the original bit positions (shifted to the left by 2).
\\\\
A \emph{Set IPv4 ECN} action uses the following structure and fields:

\input{struct/ofp_action_nw_ecn}
The \verb|nw_ecn| field is the 2 lower bits of the ECN field to set, in the original bit positions.
\\\\
A \emph{Set IPv4 TTL} action uses the following structure and fields:

\input{struct/ofp_action_nw_ttl}
The \verb|nw_ttl| field is the TTL address to set in the IP header.
\\\\
An \emph{Decrement IPv4 TTL} action takes no arguments and consists only of a generic \verb|ofp_action_header|.  This action decrement the TTL in the IP header if one is present.
\\\\
A \emph{Set transport source port} action and \emph{Set transport destination port} action use the following structure and fields:

\input{struct/ofp_action_tp_port}
The \verb|tp_port| field is the TCP/UDP/SCTP/other port to set.
\\\\
A \emph{Copy TTL outwards} action takes no arguments and consists only of a generic \verb|ofp_action_header|. The action copies the TTL from the next-to-outermost header with TTL to the outermost header with TTL.
\\\\
A \emph{Copy TTL inwards} action takes no arguments and consists only of a generic \verb|ofp_action_header|. The action copies the TTL from the outermost header with TTL to the next-to-outermost header with TTL.
\\\\
A \emph{Push VLAN header} action and \emph{Push MPLS header} action use the following structure and fields:

\input{struct/ofp_action_push}
The \verb|ethertype| indicates the Ethertype of the new tag. It is used when pushing a new VLAN tag or new MPLS header.
\\\\
A \emph{Pop VLAN header} action takes no arguments and consists only of a generic \verb|ofp_action_header|. The action pops the outermost VLAN tag from the packet.
\\\\
A \emph{Pop MPLS header} action uses the following structure and fields:

\input{struct/ofp_action_pop_mpls}
The \verb|ethertype| indicates the Ethertype of the payload.
\\\\
An \emph{Experimenter} action uses the following structure and fields:

\input{struct/ofp_action_experimenter_header}
The \verb|experimenter| field is the Experimenter ID, which takes the same form as in struct \verb|ofp_experimenter|.

\subsection{Controller-to-Switch Messages}

\subsubsection{Handshake}
\label{cts:handshake} 
Upon TLS session establishment, the controller sends an \verb|OFPT_FEATURES_REQUEST| message.  This message does not contain a body beyond the OpenFlow header.  The switch responds with an \verb|OFPT_FEATURES_REPLY| message:

\input{struct/ofp_switch_features}
The \verb|datapath_id| field uniquely identifies a datapath.  The lower 48 bits are intended for the switch MAC address, while the top 16 bits are up to the implementer.  An example use of the top 16 bits would be a VLAN ID to distinguish multiple virtual switch instances on a single physical switch.  This field should be treated as an opaque bit string by controllers.
\\\\
The \verb|n_buffers| field specifies the maximum number of packets the switch can buffer when sending packets to the controller. Switches that support buffering can send only the number of bytes specified in the switch configuration or send to controller action (see~\ref{sec:switch_config} and \ref{sec:action structures}).
\\\\
The \verb|n_tables| field describes the number of tables supported by the switch, each of which can have a different set of supported wildcard bits and number of entries.  When the controller and switch first communicate, the controller will find out how many tables the switch supports from the Features Reply. If it wishes to understand the size, types, and order in which tables are consulted, the controller sends a \verb|OFPST_TABLE| stats request. A switch must return these tables in the order the packets traverse the tables.
\\\\
The \verb|capabilities| field uses the following flags:

\input{enum/ofp_capabilities} 
The \verb|actions| field is a bitmap of actions supported by the switch.  The list of actions is found in Section~\ref{ft:actions}; all actions marked Required must be supported. Experimenter actions should \emph{not} be reported via this bitmask. The bitmask uses the values from \verb|ofp_action_type| as the number of bits to shift left for an associated action. For example, \verb|OFPAT_SET_DL_VLAN| would use the flag \verb|0x00000002|.
\\\\
The \verb|ports| field is an array of \verb|ofp_port| structures that describe all the ports in the system that support OpenFlow.  The number of port elements is inferred from the length field in the OpenFlow header. 

\subsubsection{Switch Configuration}
\label{sec:switch_config}
The controller is able to set and query configuration parameters in the switch with the \verb|OFPT_SET_CONFIG| and \verb|OFPT_GET_CONFIG_REQUEST| messages, respectively.  The switch responds to a configuration request with an \verb|OFPT_GET_CONFIG_REPLY| message; it does not reply to a request to set the configuration.  
\\\\
There is no body for \verb|OFPT_GET_CONFIG_REQUEST| beyond the OpenFlow header.  The \verb|OFPT_SET_CONFIG| and \verb|OFPT_GET_CONFIG_REPLY| use the following:

\input{struct/ofp_switch_config}
The configuration flags include the following:

\input{enum/ofp_config_flags}
The \verb|OFPC_FRAG_*| flags indicate whether IP fragments should be treated normally, dropped, or reassembled.  ``Normal" handling of fragments means that an attempt should be made to pass the fragments through the OpenFlow tables. If any field is not present (e.g., the TCP/UDP ports didn't fit), then the packet should not match any entry that has that field set.
\\\\
The \verb|OFPC_INVALID_TTL_TO_CONTROLLER| flag indicates whether packets with invalid IP TTL or MPLS TTL should be dropped or sent to the controller for processing using a \verb|OFPT_PACKET_IN| message with reason \verb|OFPR_INVALID_TTL|.  The flag is cleared by default, causing invalid packets to get dropped.
\\\\
The \verb|miss_send_len| field defines the number of bytes of each packet sent to the controller as a result of both flow table misses and flow table hits with the controller as the destination.  If this field equals 0, the switch must send a zero-size \verb|packet_in| message.

\subsubsection{Flow Table Configuration}
The controller can configure and query table state in the switch with the \verb|OFP_TABLE_MOD| and \verb|OFPST_TABLE_STATS| requests, respectively. The switch responds to a table stats request with a \verb|OFPT_STATS_REPLY| message.

\input{struct/ofp_table_mod}
The \verb|table_id| chooses the table to which the configuration change should be applied. If the \verb|table_id| is \verb|0xFF|, the configuration is applied to all tables in the switch.

The \verb|config| field is a bitmap that is used to configure the default behavior of unmatched packets. By default, any packet that does not match a table is sent to the controller for processing using a \verb|OFPT_PACKET_IN| message with reason \verb|OFPR_NO_MATCH|. This behavior can be modified by using the following flags:

\input{enum/ofp_table_config}
The \verb|OFPTC_TABLE_MISS_CONTINUE| flag directs unmatched packets to the next table in the pipeline, except for the last table of the pipeline where unmatched packets are sent to the controller.  This behavior is similar to the multiple table match process in the OpenFlow 1.0 specification. The \verb|OFPTC_TABLE_MISS_DROP| flag drops unmatched packets.

\subsubsection{Modify State Messages}
\paragraph{Modify Flow Entry Message}
Modifications to the flow table from the controller are done with the \verb|OFPT_FLOW_MOD| message:

\input{struct/ofp_flow_mod}
The \verb|cookie| field is an opaque data value chosen by the controller.  This value appears in flow removed messages and flow statistics, and can also be used to filter flow statistics, flow modification and flow deletion (see \ref{sec:flow mod messages}). It is not used by the packet processing pipeline, and thus does not need to reside in hardware.  The value -1 (0xffffffffffffffff) is reserved and must not be used. When a flow is inserted in a table through an \verb|OFPC_ADD| message, its \verb|cookie| field is set to the provided value. When a flow is modified (\verb|OFPC_MODIFY| or \verb|OFPC_MODIFY_STRICT| messages), the \verb|cookie| field is ignored.
\\\\
If the \verb|cookie_mask| field is non-zero, it is used with the \verb|cookie| field to restrict flow matching while modifying or deleting flows.  When used in a modify, a non-zero \verb|cookie_mask| also prevents a new flow from getting inserted. This field is ignored by \verb|OFPC_ADD| messages. The \verb|cookie_mask| field's behavior is explained in Section \ref{flow_table:sec_chan:flow_add}.
\\\\
The \verb|table_id| field specifies the table into which the flow should be inserted.
Table 0 signifies the first table in the pipeline. The behavior of \verb|table_id| value \verb|0xFF| is undefined.
\\\\
The \verb|command| field must be one of the following:

\input{enum/ofp_flow_mod_command}
The differences between \verb|OFPFC_MODIFY| and \verb|OFPFC_MODIFY_STRICT| are explained in Section \ref{flow_table:sec_chan:flow_mod} and differences between \verb|OFPFC_DELETE| and \verb|OFPFC_DELETE_STRICT| are explained in Section \ref{flow_table:sec_chan:flow_removal}.
\\\\
The \verb|idle_timeout| and \verb|hard_timeout| fields control how quickly flows expire. When a flow is inserted in a table, its \verb|idle_timeout| and \verb|hard_timeout| fields are set with the values from the message. When a flow is modified (\verb|OFPC_MODIFY| or \verb|OFPC_MODIFY_STRICT| messages), the \verb|idle_timeout| and \verb|hard_timeout| fields are ignored.
\\\\
If the \verb|idle_timeout| is set and the \verb|hard_timeout| is zero, the entry must expire after \verb|idle_timeout| seconds with no received traffic.  If the \verb|idle_timeout| is zero and the \verb|hard_timeout| is set, the entry must expire in \verb|hard_timeout| seconds regardless of whether or not packets are hitting the entry.
\\\\
If both \verb|idle_timeout| and \verb|hard_timeout| are set, the flow will timeout after \verb|idle_timeout| seconds with no traffic, or \verb|hard_timeout| seconds, whichever comes first.  If both \verb|idle_timeout| and \verb|hard_timeout| are zero, the entry is considered permanent and will never time out.  It can still be removed with a \verb|flow_mod| message of type \verb|OFPFC_DELETE|. 
\\\\
The \verb|priority| indicates priority within the specified flow table table. Higher numbers indicate higher priorities. This field is used only for \verb|OFPC_ADD|, \verb|OFPC_MODIFY| or \verb|OFPC_MODIFY_STRICT| messages.
\\\\
The \verb|buffer_id| refers to a packet buffered at the switch and sent to the controller by a packet-in message.  A flow mod that includes a valid \verb|buffer_id| is effectively equivalent to sending a two-message sequence of a flow mod and a packet-out to \verb|OFPP_TABLE|, with the requirement that the switch must fully process the flow mod before the packet out.  These semantics apply regardless of the table to which the flow mod refers, or the instructions contained in the flow mod. This field is ignored by \verb|OFPC_DELETE| and \verb|OFPC_DELETE_STRICT| flow mod messages.
\\\\
The \verb|out_port| and \verb|out_group| fields optionally filter the scope of  \verb|OFPC_DELETE| and \verb|OFPC_DELETE_STRICT| messages by output port and group.  If either \verb|out_port| or \verb|out_group| contains a value other than \verb|OFPP_ANY| or \verb|OFPG_ANY| respectively, it introduces a constraint when matching.  This constraint is that the rule must contain an output action directed at that port or group.  Other constraints such as \verb|ofp_match| structs and priorities are still used; this is purely an \emph{additional} constraint.  Note that to disable output filtering, both \verb|out_port| and \verb|out_group| must be set to \verb|OFPP_ANY| and \verb|OFPG_ANY| respectively.  This field is ignored by \verb|OFPC_ADD|, \verb|OFPC_MODIFY| or \verb|OFPC_MODIFY_STRICT| messages.
\\\\
The \verb|flags| field may include the follow flags:

\input{enum/ofp_flow_mod_flags}
When the \verb|OFPFF_SEND_FLOW_REM| flag is set, the switch must send a flow removed message when the flow expires.
\\\\
When the \verb|OFPFF_CHECK_OVERLAP| flag is set, the switch must check that there are no conflicting entries with the same priority. If there is one, the flow mod fails and an error code is returned.
\\\\
When a flow is inserted in a table, its \verb|flags| field is set with the values from the message. When a flow is matched and modified (\verb|OFPC_MODIFY| or \verb|OFPC_MODIFY_STRICT| messages), the \verb|flags| field is ignored.
\\\\
The \verb|instructions| field contains the instruction set for the flow entry when adding or modifying entries. The switch should return an error with \verb|OFPET_BAD_ACTION| and \verb|OFPBAC_UNSUPPORTED_ORDER| type and code if the instruction set contains an Apply-Actions instruction and the action list contains an action order that the switch cannot support.

\paragraph{Modify Group Entry Message}
Modifications to the group table from the controller are done with the \verb|OFPT_GROUP_MOD| message:

\input{struct/ofp_group_mod}
The semantics of the type and group fields are explained in \ref{group_table:sec_chan:group_mod}.
\\\\
The \verb|command| field must be one of the following:

\input{enum/ofp_group_mod_command}
The \verb|type| field must be one of the following:

\input{enum/ofp_group_type}
Buckets use the following struct:

\input{struct/ofp_bucket}
The \verb|weight| field is only defined for select groups.  The bucket's share of the traffic processed by the group is defined by the individual bucket's weight divided by the sum of the bucket weights in the group.  When a port goes down, the change in traffic distribution is undefined.  The precision by which a switch's packet distribution should match bucket weights is undefined.
\\\\
The \verb|watch_port| and \verb|watch_group| fields are only required for fast failover groups, and may be optionally implemented for other group types.  These fields indicate the port and/or group whose liveness controls whether this bucket is a candidate for forwarding.  For fast failover groups, the first bucket defined is the highest-priority bucket, and only the highest-priority live bucket is used.

\paragraph{Port Modification Message}
The controller uses the \verb|OFPT_PORT_MOD| message to modify the behavior of the port:

\input{struct/ofp_port_mod}
The \verb|mask| field is used to select bits in the \verb|config| field to change.  The \verb|advertise| field has no mask; all port features change together.

\subsubsection{Queue Configuration Messages}
Queue configuration takes place outside the OpenFlow protocol, either
  through a command line tool or through an external dedicated configuration
protocol.
\\\\
The controller can query the switch for configured queues on a port
using the following structure:
\input{struct/ofp_queue_get_config_request}
The switch replies back with an \verb|ofp_queue_get_config_reply| command, containing
a list of configured queues.

\input{struct/ofp_queue_get_config_reply}


\subsubsection{Read State Messages}
While the system is running, the datapath may be queried about its current state using the \verb|OFPT_STATS_REQUEST| message:

\input{struct/ofp_stats_request}
The switch responds with one or more \verb|OFPT_STATS_REPLY| messages:

\input{struct/ofp_stats_reply}
The only value defined for \verb|flags| in a reply is whether more replies will follow this one - this has the value \verb|0x0001|.  To ease implementation, the switch is allowed to send replies with no additional entries.  However, it must always send another reply following a message with the \emph{more} flag set.  The transaction ids (xid) of replies must always match the request that prompted them.
\\\\
In both the request and response, the \verb|type| field specifies the kind of information being passed and determines how the \verb|body| field is interpreted:

\input{enum/ofp_stats_types}

In all types of statistics reply, if a specific numeric counter is not available in the switch, its value should be set to -1. Counters wrap around with no overflow indicator.

\paragraph{Description Statistics}
Information about the switch manufacturer, hardware revision, software revision, serial number, and a description field is available from the \verb|OFPST_DESC| stats request type:

\input{struct/ofp_desc_stats}
Each entry is ASCII formatted and padded on the right with null bytes (\textbackslash0).  \verb|DESC_STR_LEN| is \input{define/DESC_STR_LEN}and \verb|SERIAL_NUM_LEN| is \input{define/SERIAL_NUM_LEN}.  Note: \footnote{Added to address concerns raised in \url{https://mailman.stanford.edu/pipermail/openflow-spec/2009-September/000504.html}} the \verb|dp_desc| field is a free-form string to describe the datapath for debugging purposes, e.g., ``switch3 in room 3120''.  As such, it is not guaranteed to be unique and should not be used as the primary identifier for the datapath---use the \verb|datapath_id| field from the switch features instead (\S~\ref{cts:handshake}).

\paragraph{Individual Flow Statistics}
Information about individual flows is requested with the \verb|OFPST_FLOW| stats request type:

\input{struct/ofp_flow_stats_request}
The \verb|match| field contains a description of the flows that should be matched and may contain wildcards.  This field's matching behavior is described in Section \ref{flow_table:sec_chan:flow_add}.
\\\\
The \verb|table_id| field indicates the index of a single table to read, or \verb|0xff| for all tables.
\\\\
The \verb|out_port| and \verb|out_group| fields optionally filter by output port and group.  If either \verb|out_port| or \verb|out_group| contain a value other than \verb|OFPP_ANY| and \verb|OFPG_ANY| respectively, it introduces a constraint when matching.  This constraint is that the rule must contain an output action directed at that port or group.  Other constraints such as \verb|ofp_match| structs are still used; this is purely an \emph{additional} constraint.  Note that to disable output filtering, both \verb|out_port| and \verb|out_group| must be set to \verb|OFPP_ANY| and \verb|OFPG_ANY| respectively.
\\\\
The usage of the \verb|cookie| and \verb|cookie_mask| fields is defined in Section \ref{flow_table:sec_chan:flow_add}.
\\\
The \verb|body| of the reply consists of an array of the following:

\input{struct/ofp_flow_stats}
The fields consist of those provided in the \verb|flow_mod| that created these, plus the table into which the entry was inserted, the packet count, and the byte count.
\\\\
\label{flow_duration_info}The \verb|duration_sec| and \verb|duration_nsec| fields indicate the elapsed time the flow has been installed in the switch. The total duration in nanoseconds can be computed as $\verb|duration_sec|*10^{9}$ + \verb|duration_nsec|. Implementations are required to provide millisecond precision; higher precision is encouraged where available.

\paragraph{Aggregate Flow Statistics}
Aggregate information about multiple flows is requested with the \verb|OFPST_AGGREGATE| stats request type:

\input{struct/ofp_aggregate_stats_request}

The fields in this message have the same meanings as in the individual flow stats request type (\verb|OFPST_FLOW|).
\\\\
The \verb|body| of the reply consists of the following:

\input{struct/ofp_aggregate_stats_reply} 

\paragraph{Table Statistics}
Information about tables is requested with the \verb|OFPST_TABLE| stats request type.  The request does not contain any data in the body.
\\\\
The body of the reply consists of an array of the following:

\input{struct/ofp_table_stats}
The \verb|body| contains a \verb|wildcards| field, which indicates the fields for which that particular table supports wildcarding. For example, a direct look-up hash table would have that field set to zero, while a sequentially searched table would have it set to \verb|OFPFW_ALL|. The entries are returned in the order that packets traverse the tables. 
\\\\
The \verb|write_actions| field is a bitmap of actions supported by the table using the \verb|OFPIT_WRITE_ACTIONS| instruction, whereas the \verb|apply_actions| field refers to the \verb|OFPIT_APPLY_ACTIONS| instruction.  The list of actions is found in Section~\ref{ft:actions}. Experimenter actions should \emph{not} be reported via this bitmask. The bitmask uses the values from \verb|ofp_action_type| as the number of bits to shift left for an associated action. For example, \verb|OFPAT_SET_DL_VLAN| would use the flag \verb|0x00000002|.
\\\\
\verb|OFP_MAX_TABLE_NAME_LEN| is \input{define/OFP_MAX_TABLE_NAME_LEN}.

\paragraph{Port Statistics}
Information about ports is requested with the \verb|OFPST_PORT| stats request type:

\input{struct/ofp_port_stats_request}
The \verb|port_no| field optionally filters the stats request to the given port.  To request all port statistics, \verb|port_no| must be set to \verb|OFPP_ANY|.
\\\\
The \verb|body| of the reply consists of an array of the following:

\input{struct/ofp_port_stats}

\paragraph{Queue Statistics}
The \verb|OFPST_QUEUE| stats request message provides queue statistics for one or more ports and one or more queues. The request body contains a \verb|port_no| field identifying the OpenFlow port for which statistics are requested, or \verb|OFPP_ANY| to refer to all ports. The \verb|queue_id| field identifies one of the priority queues, or \verb|OFPQ_ALL| to refer to all queues configured at the specified port.

\input{struct/ofp_queue_stats_request}
The body of the reply consists of an array of the following structure:

\input{struct/ofp_queue_stats}

\paragraph{Group Statistics}
The \verb|OFPST_GROUP| stats request message provides statistics for one or more groups.  The request body consists of a \verb|group_id| field, which can be set to \verb|OFPG_ALL| to refer to all groups on the switch.

\input{struct/ofp_group_stats_request}
The body of the reply consists of an array of the following structure:

\input{struct/ofp_group_stats}
The \verb|bucket_stats| field consists of an array of \verb|ofp_bucket_counter| structs:

\input{struct/ofp_bucket_counter}

\paragraph{Group Description Statistics}
The \verb|OFPST_GROUP_DESC| stats request message provides a way to list the set of groups on a switch, along with their corresponding bucket actions.  The request body is empty, while the reply body is an array of the following structure:

\input{struct/ofp_group_desc_stats}
Fields for group description stats are the same as those used with the \verb|ofp_group_mod| struct.

\paragraph{Experimenter Statistics}
Experimenter-specific stats messages are requested with the \verb|OFPST_EXPERIMENTER| stats type. The first four bytes of the message are the experimenter identifier. The rest of the body is experimenter-defined.
\\\\
The \verb|experimenter| field is a 32-bit value that uniquely identifies the experimenter. If the most significant byte is zero, the next three bytes are the experimenter's IEEE OUI. If experimenter does not have (or wish to use) their OUI, they should contact the OpenFlow consortium to obtain one. 

\subsubsection{Packet-Out Message}
When the controller wishes to send a packet out through the datapath, it uses the \verb|OFPT_PACKET_OUT| message:

\input{struct/ofp_packet_out}
The \verb|buffer_id| is the same given in the \verb|ofp_packet_in| message.  If the \verb|buffer_id| is -1, then the packet data is included in the data array.
\\\\
The \verb|action| field is an action list defining how the packet should be processed by the switch. It may include packet modification, group processing and an output port. The action list of an \verb|OFPT_PACKET_OUT| message can also specify the \verb|OFPP_TABLE| reserved virtual port as an output action to process the packet through the existing flow entries, starting at the first flow table. If \verb|OFPP_TABLE| is specified, the \verb|in_port| field is used as the ingress port in the flow table lookup.  The \verb|in_port| field must be set to either a valid switch port or \verb|OFPP_CONTROLLER|.
\\\\
Packets sent to \verb|OFPP_TABLE| may be forwarded back to the controller as the result of a flow action or table miss.  Detecting and taking action for such controller-to-switch loops is outside the scope of this specification. In general, OpenFlow messages are not guaranteed to be processed in order, therefore if a \verb|OFPT_PACKET_OUT| message using \verb|OFPP_TABLE| depends on a flow that was recently sent to the switch (with a \verb|OFPT_FLOW_MOD| message), a \verb|OFPT_BARRIER_REQUEST| message may be required prior to the \verb|OFPT_PACKET_OUT| message to make sure the flow was committed to the flow table prior to execution of \verb|OFPP_TABLE|.

\subsubsection{Barrier Message}
When the controller wants to ensure message dependencies have been met or wants to receive notifications for completed operations, it may use an \verb|OFPT_BARRIER_REQUEST| message.  This message has no body.  Upon receipt, the switch must finish processing all previously-received messages, including sending corresponding reply or error messages, before executing any messages beyond the Barrier Request.  When such processing is complete, the switch must send an \verb|OFPT_BARRIER_REPLY| message with the \verb|xid| of the original request.

\subsection{Asynchronous Messages}
\subsubsection{Packet-In Message}
When packets are received by the datapath and sent to the controller, they use the \verb|OFPT_PACKET_IN| message:

\input{struct/ofp_packet_in}
The \verb|in_phy_port| is the physical port on which the packet was received. The \verb|in_port| is the virtual port through which a packet was received, or physical port if the packet was not received on a virtual port. The port referenced by the \verb|in_port| field must be the port used for matching flows (see \ref{sec:matching}) and must be available to OpenFlow processing (i.e. OpenFlow can forward packet to this port, depending on port flags).
\\\\
For example, consider a packet received on a tunnel interface.  This tunnel interface is defined over a link aggregation group (LAG) with two physical port members and the tunnel interface is the virtual port bound to OpenFlow.  In this case, the \verb|in_port| is the tunnel port\_no and the \verb|in_phy_port| is the physical port\_no member of the LAG on which the tunnel is configured. If a packet is received directly on a physical port and not processed by a virtual port, \verb|in_port| should have the same value as \verb|in_phy_port|.
\\\\
The \verb|buffer_id| is an opaque value used by the datapath to identify a buffered packet.  When a packet is buffered, some number of bytes from the message will be included in the data portion of the message.  If the packet is sent because of a ``send to controller'' action, then \verb|max_len| bytes from the \verb|ofp_action_output| of the flow setup request are sent.  If the packet is sent because of a flow table miss, then at least \verb|miss_send_len| bytes from the \verb|OFPT_SET_CONFIG| message are sent.  The default \verb|miss_send_len| is \input{define/OFP_DEFAULT_MISS_SEND_LEN}bytes.  If the packet is not buffered, the entire packet is included in the data portion, and the \verb|buffer_id| is -1.  
\\\\
Switches that implement buffering are expected to expose, through documentation, both the amount of available buffering, and the length of time before buffers may be reused.  A switch must gracefully handle the case where a buffered \verb|packet_in| message yields no response from the controller.  A switch should prevent a buffer from being reused until it has been handled by the controller, or some amount of time (indicated in documentation) has passed.
\\\\
The reason field can be any of these values:

\input{enum/ofp_packet_in_reason}
 
\subsubsection{Flow Removed Message}
If the controller has requested to be notified when flows time out, the datapath does this with the \verb|OFPT_FLOW_REMOVED| message:

\input{struct/ofp_flow_removed}
The \verb|match|, \verb|cookie|, and \verb|priority| fields are the same as those used in the flow setup request.
\\\\
The \verb|reason| field is one of the following:

\input{enum/ofp_flow_removed_reason}
The \verb|duration_sec| and \verb|duration_nsec| fields are described in Section \ref{flow_duration_info}.
\\\\
The \verb|idle_timeout| field is directly copied from the flow mod that created this entry. 
\\\\
With the above three fields, one can find both the amount of time the flow was active, as well as the amount of time the flow received traffic.
\\\\
The \verb|packet_count| and \verb|byte_count| indicate the number of packets and bytes that were associated with this flow, respectively. The switch should return a value of -1 for unavailable counters.
 
\subsubsection{Port Status Message}
As ports are added, modified, and removed from the datapath, the controller needs to be informed with the \verb|OFPT_PORT_STATUS| message:

\input{struct/ofp_port_status}
The \verb|status| can be one of the following values:

\input{enum/ofp_port_reason} 

\subsubsection{Error Message}
There are times that the switch needs to notify the controller of a problem.  This is done with the \verb|OFPT_ERROR_MSG| message: 	

\input{struct/ofp_error_msg}
The \verb|type| value indicates the high-level type of error.  The \verb|code| value is interpreted based on the type.  The \verb|data| is variable length and interpreted based on the \verb|type| and \verb|code|. Unless specified otherwise, the \verb|data| field contains at least 64 bytes of the failed request that caused the error message to be generated, if the failed request is shorter than 64 bytes it should be the full request without any padding.
\\\\
Error codes ending in \verb|_EPERM| correspond to a permissions error generated by an entity between a controller and switch, such as an OpenFlow hypervisor. 
\\\\
Currently defined error types are:

\input{enum/ofp_error_type}
For the \verb|OFPET_HELLO_FAILED| error \verb|type|, the following \verb|code|s are currently defined:

\input{enum/ofp_hello_failed_code}
The \verb|data| field contains an ASCII text string that adds detail on why the error occurred.
\\\\
For the \verb|OFPET_BAD_REQUEST| error \verb|type|, the following \verb|code|s are currently defined:

\input{enum/ofp_bad_request_code}

For the \verb|OFPET_BAD_ACTION| error \verb|type|, the following \verb|code|s are currently defined:

\input{enum/ofp_bad_action_code}

For the \verb|OFPET_BAD_INSTRUCTION| error \verb|type|, the following \verb|code|s are currently defined:

\input{enum/ofp_bad_instruction_code}

For the \verb|OFPET_BAD_MATCH| error \verb|type|, the following \verb|code|s are currently defined:

\input{enum/ofp_bad_match_code}

For the \verb|OFPET_FLOW_MOD_FAILED| error \verb|type|, the following \verb|code|s are currently defined:

\input{enum/ofp_flow_mod_failed_code}

For the \verb|OFPET_GROUP_MOD_FAILED| error \verb|type|, the following \verb|code|s are currently defined:

\input{enum/ofp_group_mod_failed_code}

For the \verb|OFPET_PORT_MOD_FAILED| error \verb|type|, the following \verb|code|s are currently defined:

\input{enum/ofp_port_mod_failed_code}

For the \verb|OFPET_TABLE_MOD_FAILED| error \verb|type|, the following \verb|code|s are currently defined:

\input{enum/ofp_table_mod_failed_code}

For the \verb|OFPET_QUEUE_OP_FAILED| error \verb|type|, the following \verb|code|s are currently defined:

\input{enum/ofp_queue_op_failed_code}

For the \verb|OFPET_SWITCH_CONFIG_FAILED| error \verb|type|, the following \verb|code|s are currently defined:

\input{enum/ofp_switch_config_failed_code}

If the error message is in response to a specific message from the controller, e.g., \verb|OFPET_BAD_REQUEST|, \verb|OFPET_BAD_ACTION|, \verb|OFPET_BAD_INSTRUCTION|, \verb|OFPET_BAD_MATCH|, or \verb|OFPET_FLOW_MOD_FAILED|, then the \verb|xid| field of the header should match that of the offending message.

\subsection{Symmetric Messages}
\subsubsection{Hello}
The \verb|OFPT_HELLO| message has no body; that is, it consists only of an OpenFlow header. Implementations must be prepared to receive a hello message that includes a body, ignoring its contents, to allow for later extensions. 

\subsubsection{Echo Request}
An Echo Request message consists of an OpenFlow header plus an arbitrary-length data field.  The data field might be a message timestamp to check latency, various lengths to measure bandwidth, or zero-size to verify liveness between the switch and controller.

\subsubsection{Echo Reply}
An Echo Reply message consists of an OpenFlow header plus the unmodified data field of an echo request message.
\\\\
In an OpenFlow protocol implementation divided into multiple layers, the echo request/reply logic should be implemented in the "deepest" practical layer.  For example, in the OpenFlow reference implementation that includes a userspace process that relays to a kernel module, echo request/reply is implemented in the kernel module.  Receiving a correctly formatted echo reply then shows a greater likelihood of correct end-to-end functionality than if the echo request/reply were implemented in the userspace process, as well as providing more accurate end-to-end latency timing.

\subsubsection{Experimenter}
The Experimenter message is defined as follows:

\input{struct/ofp_experimenter_header}
The \verb|experimenter| field is a 32-bit value that uniquely identifies the experimenter. If the most significant byte is zero, the next three bytes are the experimenter's IEEE OUI. If experimenter does not have (or wish to use) their OUI, they should contact the OpenFlow consortium to obtain one. The rest of the body is uninterpreted.
\\\\
If a switch does not understand a experimenter extension, it must send an \verb|OFPT_ERROR| message with a \verb|OFPBRC_BAD_EXPERIMENTER| error code and \verb|OFPET_BAD_REQUEST| error type. 

%\end{appendices}
